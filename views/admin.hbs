<div class="container py-4">
    <h2 class="mb-4">Bảng điều khiển Admin</h2>

    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button"
                role="tab">Đơn hàng</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button"
                role="tab">Sản phẩm</button>
        </li>
    </ul>

    <div class="tab-content pt-3">
        <!-- Orders Tab -->
        <div class="tab-pane fade show active" id="orders" role="tabpanel" aria-labelledby="orders-tab">
            <div class="table-responsive">
                <table class="table align-middle" id="ordersTable">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Ngày tạo</th>
                            <th class="text-end">Tổng</th>
                            <th>Trạng thái</th>
                            <th style="width:120px;"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Products Tab -->
        <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">Thêm sản phẩm</h5>
                    <form id="addProductForm" class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tên</label>
                            <input name="name" class="form-control" required />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Giá</label>
                            <input name="price" type="number" class="form-control" min="0" step="1" required />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Số lượng</label>
                            <input name="stock" type="number" class="form-control" min="0" step="1" value="0" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Danh mục</label>
                            <input name="category" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ảnh (URL)</label>
                            <input name="image" class="form-control" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Mô tả</label>
                            <textarea name="description" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-12 d-flex justify-content-end">
                            <button class="btn btn-primary" type="submit">Thêm</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table align-middle" id="productsTable">
                    <thead>
                        <tr>
                            <th>Tên</th>
                            <th class="text-end">Giá</th>
                            <th>Danh mục</th>
                            <th style="width:120px;"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        // Helpers
        function fmtCurrency(n) { try { return (n || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }); } catch { return n; } }

        // Orders load + update
        async function loadOrders() {
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Đang tải...</td></tr>`;
            try {
                const res = await fetch('/api/admin/orders', { credentials: 'include' });
                const data = await res.json();
                const orders = data?.orders || [];
                if (orders.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center">Không có đơn hàng.</td></tr>`;
                    return;
                }
                tbody.innerHTML = orders.map(o => `
          <tr data-id="${o._id}">
            <td class="small">${o._id}</td>
            <td>${new Date(o.createdAt).toLocaleString('vi-VN')}</td>
            <td class="text-end">${fmtCurrency(o.total)}</td>
            <td>
              <select class="form-select form-select-sm" data-role="status">
                ${['pending', 'processing', 'shipped', 'delivered'].map(s => `<option value="${s}" ${o.status === s ? 'selected' : ''}>${s}</option>`).join('')}
              </select>
            </td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary" data-action="update-status">Cập nhật</button>
            </td>
          </tr>
        `).join('');
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Không tải được đơn hàng.</td></tr>`;
            }
        }

        document.querySelector('#ordersTable tbody')?.addEventListener('click', async (e) => {
            const btn = e.target.closest('button[data-action="update-status"]');
            if (!btn) return;
            const tr = btn.closest('tr');
            const id = tr?.dataset?.id;
            const status = tr?.querySelector('[data-role="status"]').value;
            try {
                const res = await fetch(`/api/admin/orders/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status })
                });
                if (!res.ok) throw new Error('Update failed');
                showToast('Cập nhật trạng thái thành công!', 'success');
            } catch (err) {
                showToast('Cập nhật thất bại.', 'danger');
            }
        });

        // Products load/list
        async function loadProducts() {
            const tbody = document.querySelector('#productsTable tbody');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Đang tải...</td></tr>`;
            try {
                const res = await fetch('/api/products', { credentials: 'include' });
                const data = await res.json();
                const products = data?.products || [];
                if (products.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center">Chưa có sản phẩm.</td></tr>`;
                    return;
                }
                tbody.innerHTML = products.map(p => `
          <tr data-id="${p._id}">
            <td>
              <input class="form-control form-control-sm" data-role="name" value="${p.name || ''}" />
            </td>
            <td class="text-end">
              <input class="form-control form-control-sm text-end" data-role="price" type="number" min="0" step="1" value="${p.price || 0}" />
            </td>
            <td>
              <input class="form-control form-control-sm" data-role="category" value="${p.category || ''}" />
            </td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" data-action="save">Lưu</button>
                <button class="btn btn-outline-danger" data-action="delete">Xóa</button>
              </div>
            </td>
          </tr>
        `).join('');
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-danger text-center">Không tải được sản phẩm.</td></tr>`;
            }
        }

        // Add product
        document.getElementById('addProductForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.currentTarget;
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());
            payload.price = Number(payload.price || 0);
            payload.stock = Number(payload.stock || 0);
            try {
                const res = await fetch('/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('Create failed');
                showToast('Đã thêm sản phẩm!', 'success');
                form.reset();
                loadProducts();
            } catch (err) {
                showToast('Không thêm được sản phẩm.', 'danger');
            }
        });

        // Save/Delete product
        document.querySelector('#productsTable tbody')?.addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const tr = btn.closest('tr');
            const id = tr?.dataset?.id;
            if (btn.dataset.action === 'save') {
                const name = tr.querySelector('[data-role="name"]').value.trim();
                const price = Number(tr.querySelector('[data-role="price"]').value || 0);
                const category = tr.querySelector('[data-role="category"]').value.trim();
                try {
                    const res = await fetch(`/api/products/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ name, price, category })
                    });
                    if (!res.ok) throw new Error('Update failed');
                    showToast('Đã lưu sản phẩm!', 'success');
                    loadProducts();
                } catch (err) {
                    showToast('Không lưu được sản phẩm.', 'danger');
                }
            }
            if (btn.dataset.action === 'delete') {
                if (!confirm('Xóa sản phẩm này?')) return;
                try {
                    const res = await fetch(`/api/products/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    if (!res.ok) throw new Error('Delete failed');
                    showToast('Đã xóa sản phẩm!', 'success');
                    tr.remove();
                } catch (err) {
                    showToast('Không xóa được sản phẩm.', 'danger');
                }
            }
        });

        // Initial loads
        loadOrders();
        loadProducts();
    })();
</script>