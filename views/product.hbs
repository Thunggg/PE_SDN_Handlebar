<div class="container py-4">
    {{#if product}}
    <div class="row g-4">
        <div class="col-12 col-md-6">
            {{#if product.image}}
            <img src="{{product.image}}" class="img-fluid rounded border bg-light p-2 w-100" alt="{{product.name}}"
                style="max-height: 420px; object-fit: contain;">
            {{else}}
            <div class="d-flex align-items-center justify-content-center bg-light border rounded" style="height:420px;">
                <span class="text-muted">Không có ảnh</span>
            </div>
            {{/if}}
        </div>
        <div class="col-12 col-md-6">
            <h2 class="mb-2">{{product.name}}</h2>
            <div class="h4 text-primary mb-3">{{product.price}} ₫</div>
            {{#if product.description}}
            <p class="text-muted">{{product.description}}</p>
            {{/if}}
            <div class="mb-3">
                {{#if product.category}}
                <span class="badge bg-secondary me-2">{{product.category}}</span>
                {{/if}}
                {{#if product.stock}}
                <span class="badge bg-success">Còn {{product.stock}} SP</span>
                {{else}}
                <span class="badge bg-danger">Hết hàng</span>
                {{/if}}
            </div>

            <div class="input-group mb-3" style="max-width: 220px;">
                <span class="input-group-text">Số lượng</span>
                <input id="qty" type="number" class="form-control" min="1" value="1">
            </div>

            <div class="d-flex gap-2">
                <button id="addToCart" class="btn btn-primary">Thêm vào giỏ</button>
                <a href="/home" class="btn btn-outline-secondary">Về danh sách</a>
            </div>
        </div>
    </div>
    {{else}}
    <div class="alert alert-warning">Không tìm thấy sản phẩm.</div>
    <a href="/home" class="btn btn-outline-secondary">Về danh sách</a>
    {{/if}}
</div>

<script>
    (function () {
        const btn = document.getElementById('addToCart');
        if (!btn) return;
        btn.addEventListener('click', async function () {
            const qtyEl = document.getElementById('qty');
            const quantity = Math.max(1, parseInt(qtyEl?.value || '1', 10));
            const productId = '{{product._id}}';
            try {
                const res = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ productId, quantity })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    const msg = (data && (data.message || data.error)) || 'Không thêm vào giỏ được.';
                    return showToast(msg, 'danger');
                }
                showToast('Đã thêm vào giỏ hàng!', 'success');
            } catch (err) {
                showToast('Có lỗi xảy ra. Vui lòng thử lại.', 'danger');
            }
        });
    })();
</script>